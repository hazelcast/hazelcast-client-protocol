{% macro encode_var_sized(param) -%}
    {% if is_var_sized_list(param.type) -%}
        ListMultiFrameCodec.encode{% if param.nullable  %}Nullable{% endif %}(clientMessage, {{ param.name }}, {{ item_type(param.type) }}Codec::encode)
    {%- elif is_var_sized_map(param.type) -%}
        MapCodec.encode{% if param.nullable  %}Nullable{% endif %}(clientMessage, {{ param.name }}, {{ key_type(param.type) }}Codec::encode, {{ value_type(param.type) }}Codec::encode)
    {%- else -%}
        {%- if param.nullable  -%}
            CodecUtil.encodeNullable(clientMessage, {{ param.name }}, {{ lang_name(param.type) }}Codec::encode)
        {%- else -%}
            {{ lang_name(param.type) }}Codec.encode(clientMessage, {{ param.name }})
        {%- endif %}
    {% endif %}
{%- endmacro %}
{% macro decode_var_sized(param) -%}
    {%- if is_var_sized_list(param.type) -%}
        ListMultiFrameCodec.decode{% if param.nullable  %}Nullable{% endif %}(iterator, {{ item_type(param.type) }}Codec::decode)
    {%- elif is_var_sized_map(param.type) -%}
        MapCodec.decode{% if param.nullable  %}Nullable{% endif %}(iterator, {{ key_type(param.type) }}Codec::decode, {{ value_type(param.type) }}Codec::decode)
    {%- else -%}
        {%- if param.nullable  -%}
            CodecUtil.decodeNullable(iterator, {{ lang_name(param.type) }}Codec::decode)
        {%- else -%}
            {{ lang_name(param.type) }}Codec.decode(iterator)
        {%- endif -%}
    {%- endif -%}
{%- endmacro %}
/*
 * Copyright (c) 2008-2019, Hazelcast, Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.hazelcast.client.impl.protocol.codec;

import com.hazelcast.client.impl.protocol.ClientMessage;
import com.hazelcast.client.impl.protocol.codec.builtin.*;

import java.util.ListIterator;

import static com.hazelcast.client.impl.protocol.ClientMessage.*;
import static com.hazelcast.client.impl.protocol.codec.builtin.FixedSizeTypesCodec.*;
{% if method.events|length != 0 %}
import com.hazelcast.logging.Logger;
{% endif %}

/**
{% for line in method.doc.splitlines() %}
 * {{ line }}
{% endfor %}
 */
public final class {{ service_name|capital }}{{ method.name|capital }}Codec {
    //hex: {{ '0x%04X'|format(method.request.id) }}
    public static final int REQUEST_MESSAGE_TYPE = {{ method.request.id }};
    //hex: {{ '0x%04X'|format(method.response.id) }}
    public static final int RESPONSE_MESSAGE_TYPE = {{ method.response.id }};
{#FIXED SIZED PARAMETER OFFSET CONSTANTS#}
{% for param in fixed_params(method.request.params) %}
    private static final int REQUEST_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET = {% if loop.first %}PARTITION_ID_FIELD_OFFSET + INT_SIZE_IN_BYTES{% else %}REQUEST_{{ to_upper_snake_case(loop.previtem.name)}}_FIELD_OFFSET + {{loop.previtem.type.upper()}}_SIZE_IN_BYTES{% endif %};
    {% if loop.last %}
    private static final int REQUEST_INITIAL_FRAME_SIZE = REQUEST_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET + {{param.type.upper()}}_SIZE_IN_BYTES;
    {% endif %}
{% else %}
    private static final int REQUEST_INITIAL_FRAME_SIZE = PARTITION_ID_FIELD_OFFSET + INT_SIZE_IN_BYTES;
{% endfor %}
{% for param in fixed_params(method.response.params) %}
    private static final int RESPONSE_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET = {% if loop.first %}CORRELATION_ID_FIELD_OFFSET + LONG_SIZE_IN_BYTES{% else %}RESPONSE_{{ to_upper_snake_case(loop.previtem.name)}}_FIELD_OFFSET + {{loop.previtem.type.upper()}}_SIZE_IN_BYTES{% endif %};
    {% if loop.last %}
    private static final int RESPONSE_INITIAL_FRAME_SIZE = RESPONSE_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET + {{param.type.upper()}}_SIZE_IN_BYTES;
    {% endif %}
{% else %}
    private static final int RESPONSE_INITIAL_FRAME_SIZE = CORRELATION_ID_FIELD_OFFSET + LONG_SIZE_IN_BYTES;
{% endfor %}
{% for event in method.events%}
    {% for param in fixed_params(event.params) %}
    private static final int EVENT_{{ to_upper_snake_case(event.name)}}_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET = {% if loop.first %}PARTITION_ID_FIELD_OFFSET + INT_SIZE_IN_BYTES{% else %}EVENT_{{ to_upper_snake_case(event.name)}}_{{ to_upper_snake_case(loop.previtem.name)}}_FIELD_OFFSET + {{loop.previtem.type.upper()}}_SIZE_IN_BYTES{% endif %};
    {% if loop.last %}
    private static final int EVENT_{{ to_upper_snake_case(event.name)}}_INITIAL_FRAME_SIZE = EVENT_{{ to_upper_snake_case(event.name)}}_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET + {{param.type.upper()}}_SIZE_IN_BYTES;
    {% endif %}
    {% else %}
    private static final int EVENT_{{ to_upper_snake_case(event.name)}}_INITIAL_FRAME_SIZE = PARTITION_ID_FIELD_OFFSET + INT_SIZE_IN_BYTES;
    {% endfor %}
    //hex: {{ '0x%04X'|format(event.id) }}
    private static final int EVENT_{{ to_upper_snake_case(event.name)}}_MESSAGE_TYPE = {{ event.id }};
{% endfor %}

    private {{ service_name|capital }}{{ method.name|capital }}Codec() {
    }

{#REQUEST PARAMETERS#}
    @edu.umd.cs.findbugs.annotations.SuppressFBWarnings({"URF_UNREAD_PUBLIC_OR_PROTECTED_FIELD"})
    public static class RequestParameters {
    {% for param in method.request.params %}

        /**
        {% for line in param.doc.splitlines() %}
         * {{ line }}
        {% endfor %}
         */
        public {{ lang_types_decode(param.type) }} {{ param.name }};
    {% endfor %}
    }

{#REQUEST_ENCODE#}
    public static ClientMessage encodeRequest({% for param in method.request.params %}{{ lang_types_encode(param.type) }} {{param.name}}{% if not loop.last %}, {% endif %}{% endfor %}) {
        ClientMessage clientMessage = ClientMessage.createForEncode();
        clientMessage.setRetryable({{ method.request.retryable|lower }});
        clientMessage.setAcquiresResource({{ method.request.acquiresResource|lower }});
        clientMessage.setOperationName("{{ service_name|capital }}.{{ method.name|capital }}");
        ClientMessage.Frame initialFrame = new ClientMessage.Frame(new byte[REQUEST_INITIAL_FRAME_SIZE], UNFRAGMENTED_MESSAGE);
        encodeInt(initialFrame.content, TYPE_FIELD_OFFSET, REQUEST_MESSAGE_TYPE);
    {% for param in fixed_params(method.request.params) %}
        encode{{ param.type|capital }}(initialFrame.content, REQUEST_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET, {{ param.name }});
    {% endfor %}
        clientMessage.addFrame(initialFrame);
    {% for param in var_size_params(method.request.params) %}
        {{ encode_var_sized(param) }};
    {% endfor %}
        return clientMessage;
    }

{#REQUEST_DECODE#}
    public static {{ service_name|capital }}{{ method.name|capital }}Codec.RequestParameters decodeRequest(ClientMessage clientMessage) {
        ListIterator<ClientMessage.Frame> iterator = clientMessage.iterator();
        RequestParameters request = new RequestParameters();
    {% if  fixed_params(method.request.params)|length != 0 %}
        ClientMessage.Frame initialFrame = iterator.next();
    {% else %}
        //empty initial frame
        iterator.next();
    {% endif %}
    {% for param in fixed_params(method.request.params) %}
        request.{{ param.name }} = decode{{ param.type|capital }}(initialFrame.content, REQUEST_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET);
    {% endfor %}
    {% for param in var_size_params(method.request.params) %}
        request.{{ param.name }} = {{ decode_var_sized(param) }};
    {% endfor %}
        return request;
    }

{#RESPONSE PARAMETERS#}
    @edu.umd.cs.findbugs.annotations.SuppressFBWarnings({"URF_UNREAD_PUBLIC_OR_PROTECTED_FIELD"})
    public static class ResponseParameters {
{% for param in method.response.params %}

        /**
        {% for line in param.doc.splitlines() %}
         * {{ line }}
        {% endfor %}
         */
        public {{ lang_types_decode(param.type) }} {{ param.name }};
{% endfor %}
    }

{#RESPONSE ENCODE#}
    public static ClientMessage encodeResponse({% for param in method.response.params %}{{ lang_types_encode(param.type) }} {{param.name}}{% if not loop.last %}, {% endif %}{% endfor %}) {
        ClientMessage clientMessage = ClientMessage.createForEncode();
        ClientMessage.Frame initialFrame = new ClientMessage.Frame(new byte[RESPONSE_INITIAL_FRAME_SIZE], UNFRAGMENTED_MESSAGE);
        encodeInt(initialFrame.content, TYPE_FIELD_OFFSET, RESPONSE_MESSAGE_TYPE);
        clientMessage.addFrame(initialFrame);

    {% for param in fixed_params(method.response.params) %}
        encode{{ param.type|capital }}(initialFrame.content, RESPONSE_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET, {{ param.name }});
    {% endfor %}
    {% for param in var_size_params(method.response.params) %}
        {{ encode_var_sized(param) }};
    {% endfor %}
        return clientMessage;
    }

{#RESPONSE DECODE#}
    public static {{ service_name|capital }}{{ method.name|capital }}Codec.ResponseParameters decodeResponse(ClientMessage clientMessage) {
        ListIterator<ClientMessage.Frame> iterator = clientMessage.iterator();
        ResponseParameters response = new ResponseParameters();
        {% if  fixed_params(method.response.params)|length != 0 %}
        ClientMessage.Frame initialFrame = iterator.next();
        {% else %}
        //empty initial frame
        iterator.next();
        {% endif %}
    {% for param in fixed_params(method.response.params) %}
        response.{{ param.name }} = decode{{ param.type|capital }}(initialFrame.content, RESPONSE_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET);
    {% endfor %}
    {% for param in var_size_params(method.response.params) %}
        response.{{ param.name }} = {{ decode_var_sized(param) }};
    {% endfor %}
        return response;
    }

{# EVENTS#}
{% if method.events|length != 0 %}
{% for event in method.events%}
    public static ClientMessage encode{{ event.name|capital }}Event({% for param in event.params %}{{ lang_types_encode(param.type) }} {{param.name}}{% if not loop.last %}, {% endif %}{% endfor %}) {
        ClientMessage clientMessage = ClientMessage.createForEncode();
        ClientMessage.Frame initialFrame = new ClientMessage.Frame(new byte[EVENT_{{ to_upper_snake_case(event.name)}}_INITIAL_FRAME_SIZE], UNFRAGMENTED_MESSAGE);
        initialFrame.flags |= ClientMessage.IS_EVENT;
        encodeInt(initialFrame.content, TYPE_FIELD_OFFSET, EVENT_{{ to_upper_snake_case(event.name)}}_MESSAGE_TYPE);
    {% for param in fixed_params(event.params) %}
        encode{{ param.type|capital }}(initialFrame.content, EVENT_{{ to_upper_snake_case(event.name)}}_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET, {{ param.name }});
    {% endfor %}
        clientMessage.addFrame(initialFrame);
    {% for param in var_size_params(event.params) %}
        {{ encode_var_sized(param) }};
    {% endfor %}
        return clientMessage;
    }
    {% endfor %}

    public abstract static class AbstractEventHandler {

        public void handle(ClientMessage clientMessage) {
            int messageType = clientMessage.getMessageType();
            ListIterator<ClientMessage.Frame> iterator = clientMessage.iterator();
        {% for event in method.events%}
            if (messageType == EVENT_{{ to_upper_snake_case(event.name)}}_MESSAGE_TYPE) {
            {% if  fixed_params(event.params)|length != 0 %}
                ClientMessage.Frame initialFrame = iterator.next();
            {% else %}
                //empty initial frame
                iterator.next();
            {% endif %}
            {% for param in fixed_params(event.params) %}
                {{ lang_types_decode(param.type) }} {{param.name}} = decode{{ param.type|capital }}(initialFrame.content, EVENT_{{ to_upper_snake_case(event.name)}}_{{to_upper_snake_case(param.name)}}_FIELD_OFFSET);
            {% endfor %}
            {% for param in var_size_params(event.params) %}
                {{ lang_types_decode(param.type) }} {{param.name}} = {{ decode_var_sized(param) }};
            {% endfor %}
                handle{{ event.name|capital }}Event({% for param in event.params %}{{param.name}}{% if not loop.last %}, {% endif %}{% endfor %});
                return;
            }
        {% endfor %}
            Logger.getLogger(super.getClass()).finest("Unknown message type received on event handler :" + messageType);
        }
    {% for event in method.events%}
        public abstract void handle{{ event.name|capital }}Event({% for param in event.params %}{{ lang_types_encode(param.type) }} {{param.name}}{% if not loop.last %}, {% endif %}{% endfor %});
    {% endfor %}
    }
{% endif %}
}

